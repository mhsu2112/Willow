<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Willow ‚Äî Notes & Graph</title>
<style>
  html{scroll-behavior:smooth}
  :root { --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#4f46e5; --bg:#f8fafc; --accent-soft:#eef2ff; --danger:#ef4444; --ok:#16a34a; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  nav{max-width:1000px;margin:auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .chips{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;
        color:var(--ink);text-decoration:none;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.02);transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease}
  .chip:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(2,6,23,.06);border-color:#d0d7e2}
  .chip:active{transform:translateY(0)}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .chip.badge{padding:6px 10px;border-color:#cfd8e3;color:#64748b;cursor:default}
  .chip.accent{background:var(--accent);border-color:var(--accent);color:#fff}
  .chip .emoji{filter:saturate(0.9)}
  main{max-width:1000px;margin:auto;padding:20px 16px 80px}
  h1,h2{margin:0} h2{font-size:20px;margin-top:24px}
  .grid{display:grid;gap:16px}
  .grid-cols-2{grid-template-columns:1fr}
  @media(min-width:900px){.grid-cols-2{grid-template-columns:1fr 1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px}
  label span{font-size:12px;color:var(--muted);display:block}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;margin-top:6px;background:#fff}
  textarea{resize:vertical;min-height:120px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.danger{border-color:var(--danger);color:#ef4444}
  .muted{color:var(--muted);font-size:12px}
  .list{margin:8px 0 0;padding:0 0 0 18px}
  .pill{font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
  .ok{color:var(--ok)} .err{color:var(--danger)}
  .linkbtn{background:none;border:none;padding:0;margin:0;cursor:pointer;color:inherit;text-align:left}
  svg text{font:12px ui-sans-serif,system-ui;fill:#334155}
  .edge-dashed{stroke-dasharray:4 4}
  .prop-card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
  .place-banner{display:none;background:var(--accent-soft);border:1px dashed var(--accent);color:#312e81;padding:10px 12px;border-radius:10px;align-items:center;justify-content:space-between}
  .place-mode .place-banner{display:flex}
  .placeable{transition:background .15s,box-shadow .15s}
  .place-mode .placeable{background:var(--accent-soft);box-shadow:0 0 0 2px var(--accent) inset;border-radius:8px}
  .place-target{display:none;margin-top:10px}
  .place-mode .place-target{display:block}
  .place-newroot{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border:2px dashed var(--accent);border-radius:12px;background:#fff}
  .place-mode svg g[data-id] circle{stroke:var(--accent);stroke-width:3px}
  .chat{border:1px solid var(--line);border-radius:12px;padding:10px;height:220px;overflow:auto;background:#fff}
  .bubble{padding:8px 10px;border-radius:10px;margin:6px 0;max-width:100%;white-space:pre-wrap}
  .bubble.user{background:#eef2ff;align-self:flex-end}
  .bubble.bot{background:#f1f5f9}
  .chat .bubble small{display:block;color:#64748b;margin-top:4px}
</style>

</head>
<body>
<header>
  <nav>
    <div class="chips">
      <div style="font-size:22px;">üåø</div><strong>Willow</strong>
    </div>
    <div class="chips" id="navRight">
      <a class="chip active" href="#notetaker">üìù Notes</a>
      <a class="chip" href="#graph">üìà Graph</a>
      <a class="chip" href="forecasts.html">üéØ Forecasts</a>
      <a class="chip" href="admin.html">üõ†Ô∏è Admin</a>
      <button id="newNoteBtn" class="chip accent">üÜï New Note</button>
    </div>
  </nav>
</header>

<main>
  <section id="notetaker">
    <h2>Notetaker <span class="muted">‚Ä¢ choose placement when you Publish/Save</span></h2>
    <div id="placeBanner" class="place-banner" style="margin-top:12px;">
      <div><strong>Placement Mode:</strong> click a note (place as child) or ‚ÄúNew Path‚Äù.</div>
    </div>

    <div class="grid grid-cols-2" style="margin-top:12px;">
      <form id="noteForm" class="card">
        <input id="numInput" type="hidden"/>
        <input id="hiddenKeepId" type="hidden" value="0"/>

        <label><span>Title</span><input name="title" placeholder="Your note title" required></label>
        <label style="margin-top:10px;"><span>Content</span><textarea name="content" placeholder="One idea, in your own words‚Ä¶" required></textarea></label>
        <label style="margin-top:10px;"><span>Tags (comma-separated)</span><input name="tags" placeholder="banking, liquidity, funding"></label>
        <label style="margin-top:10px;"><span>Source (optional)</span><input name="source" placeholder="link or reference"></label>

        <div class="row" style="margin-top:12px;">
          <button type="button" id="saveDraft" class="btn">Save Draft</button>
          <button type="submit" class="btn primary">Publish</button>
          <button type="button" id="deleteNote" class="btn danger">Delete Loaded</button>
          <span id="saveMsg" class="muted"></span>
        </div>

        <!-- AI Agents (Chat) -->
        <div class="card" id="agentsCard" style="margin-top:16px;">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <strong>AI Agents (HF Router Demo)</strong>
            <div class="row">
              <select id="modelPicker" title="Model"></select>
              <button type="button" id="loadModelBtn" class="btn">Load Model</button>
            </div>
          </div>
          <div class="muted" style="margin-top:6px;">Backed by AdaptLLM/finance-LLM (via FastAPI).</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn" data-tab="interconnectedness">Interconnectedness</button>
            <button class="btn" data-tab="historian">Historian</button>
            <button class="btn" data-tab="blind_spot">Blind-Spot</button>
          </div>
          <div id="agentPanels" style="margin-top:10px;">
            <div class="agent-panel" data-panel="interconnectedness" style="display:block">
              <div class="chat" id="chat-interconnectedness"></div>
              <div class="row" style="margin-top:8px;">
                <input id="inp-interconnectedness" placeholder="Ask about linkages or type '.' to analyze this note‚Ä¶" style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px"/>
                <button class="btn primary" data-send="interconnectedness">Send</button>
                <button class="btn" data-to-note="interconnectedness">Send to Notetaker</button>
                <button class="btn" data-accept="interconnectedness">Accept (choose placement)</button>
              </div>
            </div>
            <div class="agent-panel" data-panel="historian" style="display:none">
              <div class="chat" id="chat-historian"></div>
              <div class="row" style="margin-top:8px;">
                <input id="inp-historian" placeholder='Ask for historical analogs (e.g., "compare with prior sovereign episodes")' style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px"/>
                <button class="btn primary" data-send="historian">Send</button>
                <button class="btn" data-to-note="historian">Send to Notetaker</button>
                <button class="btn" data-accept="historian">Accept (choose placement)</button>
              </div>
            </div>
            <div class="agent-panel" data-panel="blind_spot" style="display:none">
              <div class="chat" id="chat-blind_spot"></div>
              <div class="row" style="margin-top:8px;">
                <input id="inp-blind_spot" placeholder="Ask for orthogonal angles / overlooked domains" style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px"/>
                <button class="btn primary" data-send="blind_spot">Send</button>
                <button class="btn" data-to-note="blind_spot">Send to Notetaker</button>
                <button class="btn" data-accept="blind_spot">Accept (choose placement)</button>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Recently Saved</strong>
          <button id="clearAll" class="btn danger">Clear All (dev)</button>
        </div>
        <ul id="recentList" class="list"></ul>

        <div id="newRootTarget" class="place-target" style="margin-top:16px;">
          <button id="placeNewRoot" class="place-newroot btn" type="button">
            ‚ûï Place at New Path <span id="nextRootPreview" class="pill"></span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <section id="graph">
    <h2 style="margin-top:24px;">Graph (Published Notes)</h2>
    <p class="muted">Scroll to zoom ‚Ä¢ drag to pan ‚Ä¢ double-click to reset. Solid edges = tag overlap; dashed = accepted links.</p>
    <div class="card" style="margin:12px 0;">
      <span class="muted">Semantic Axes: x‚Å∫ = <strong>housing</strong> ‚Üî x‚Åª = <strong>technology</strong>, y‚Å∫ = <strong>policy</strong> ‚Üî y‚Åª = <strong>energy</strong></span>
    </div>
    <div class="grid" style="grid-template-columns:2fr 1fr; margin-top:12px;">
      <div class="card">
        <svg id="kg" viewBox="0 0 800 450" style="width:100%;height:420px;">
          <g id="vp"></g>
        </svg>
      </div>
      <div class="card">
        <strong>Stats</strong>
        <ul class="list">
          <li>Nodes: <span id="statNodes" class="stat">0</span></li>
          <li>Edges (tags): <span id="statEdges" class="stat">0</span></li>
          <li>Edges (links): <span id="statEdgesLinks" class="stat">0</span></li>
        </ul>
        <div class="row" style="margin-top:10px;">
          <button id="rebuild" class="btn">Rebuild Graph</button>
          <button id="fitView" class="btn">Fit to View</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  window.WILLOW_CFG = {
    url: 'https://seolktqxdxstwqdiqzke.supabase.co',
    anon: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlb2xrdHF4ZHhzdHdxZGlxemtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjc0MjAsImV4cCI6MjA3MDk0MzQyMH0.Qt6wLLfR1QxbYGpq42t1uwpy5kDdqb_LN5-JA89Fj-U'
  };
</script>

<script>
  // Hugging Face Router (OpenAI-compatible) config for DEMO purposes.
  // WARNING: Embedding tokens in client code exposes them to anyone who can view source.
  window.WILLOW_HF_BASE  = "https://router.huggingface.co/v1";
  window.WILLOW_HF_MODEL = window.WILLOW_HF_MODEL || "AdaptLLM/finance-LLM:hf-inference";
  window.WILLOW_HF_TOKEN = "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"; // DEMO ONLY
</script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const { url, anon } = window.WILLOW_CFG;

  const originHost = new URL(url).host;
  const withApiKeyQuery = async (input, init) => {
    const reqUrl = typeof input === 'string' ? input : input.url;
    try { const u = new URL(reqUrl);
      if (u.host === originHost && u.pathname.includes('/rest/v1/') && !u.searchParams.has('apikey')) u.searchParams.set('apikey', anon);
      return fetch(u.toString(), init);
    } catch { return fetch(input, init); }
  };

  window.__supa = window.__supa || createClient(url, anon, {
    auth: { persistSession: true, autoRefreshToken: true },
    global: { headers: { apikey: anon }, fetch: withApiKeyQuery }
  });

  const supa = window.__supa;
  const { data: { session } } = await supa.auth.getSession().catch(()=>({data:{}}));
  if (!session?.user) location.href = new URL('auth.html', location.href).href;
  else {
    window.currentUserId = session.user.id;
    window.currentUserEmail = session.user.email;
    const nav = document.getElementById('navRight');
    const badge = document.createElement('span');
    badge.className='chip badge';
    badge.textContent=session.user.email||session.user.id.slice(0,8);
    const out = document.createElement('button');
    out.className='chip';
    out.textContent='Sign out';
    out.onclick = async ()=>{ try{ await (window.pushUserTagStats?.()); }catch{} await supa.auth.signOut(); location.href='auth.html'; };
    nav.appendChild(badge); nav.appendChild(out);
    try{ await (window.pushUserTagStats?.()); }catch{}
  }
</script>

<!-- Embedding model (Xenova) for vector layout -->
<script type="module">
(async () => {
  async function loadTransformers() {
    const urls = [
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js',
      'https://unpkg.com/@xenova/transformers@2.17.2/dist/transformers.min.js',
      'https://esm.sh/@xenova/transformers@2.17.2'
    ];
    for (const url of urls) {
      try { const m = await import(url); console.log('[Willow] transformers from', url); return m; }
      catch(e){ console.warn('[Willow] failed', url, e); }
    }
    throw new Error('Failed to load @xenova/transformers.');
  }
  try {
    const { pipeline, env } = await loadTransformers();
    env.useBrowserCache = true; env.allowLocalModels = false;
    const EMBED_MODEL = 'Xenova/all-MiniLM-L6-v2';
    let embedder = null;
    async function ensureEmbedder(){
      if (embedder) return embedder;
      const el = document.querySelector('#graph .muted');
      if (el) el.textContent = 'Loading embedding model (one-time)‚Ä¶';
      embedder = await pipeline('feature-extraction', EMBED_MODEL, { quantized:true });
      if (el) el.textContent = 'Scroll to zoom ‚Ä¢ drag to pan ‚Ä¢ double-click to reset. Solid edges = tag overlap; dashed = accepted links.';
      return embedder;
    }
    window.__willow_embedder = { ensureEmbedder };
    window.dispatchEvent(new Event('willow-embedder-ready'));
  } catch (err) {
    console.error('[Willow] transformers loader failed:', err);
    window.__willow_embedder = null;
    window.dispatchEvent(new Event('willow-embedder-ready'));
  }
})();
</script>

<!-- Notes, placement, stats, and graph logic -->
<script>
  const LS_NOTES='willow_notes', LS_LINKS='willow_links';
  const loadNotes=()=>{try{return JSON.parse(localStorage.getItem(LS_NOTES)||'[]')}catch{return[]}};
  const saveNotes=a=>localStorage.setItem(LS_NOTES,JSON.stringify(a));
  const loadLinks=()=>{try{return JSON.parse(localStorage.getItem(LS_LINKS)||'[]')}catch{return[]}};
  const saveLinks=a=>localStorage.setItem(LS_LINKS,JSON.stringify(a));
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const parseTags=s=>(s||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
  const escapeHtml=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const now=()=>new Date().toISOString();
  const showMsg=(t,ok=true)=>{const el=$('#saveMsg'); el.textContent=t; el.className='muted '+(ok?'ok':'err'); setTimeout(()=>{el.textContent='';el.className='muted'},2200)}
  const pad=n=>n.toString().padStart(2,'0');
  function newUID(){ const d=new Date(); const id=`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; let cand=id,i=0; const ids=new Set(loadNotes().map(n=>n.id)); while(ids.has(cand)) cand=id+'-'+(++i); return cand; }

  const isAlpha=s=>/^[a-z]+$/.test(s), isNum=s=>/^\d+$/.test(s);
  function splitNum(num){ if(!num) return null; const s=num.toLowerCase(); const m0=s.match(/^\d+/); if(!m0) return null; const parts=[m0[0]]; let i=m0[0].length;
    while(i<s.length){ const a=s.slice(i).match(/^[a-z]+/); if(a){parts.push(a[0]); i+=a[0].length; continue} const n=s.slice(i).match(/^\d+/); if(n){parts.push(n[0]); i+=n[0].length; continue} return null; } return parts; }
  const joinParts=p=>p.join('');
  function siblingsLastSegs(prefix,depth){ return loadNotes().map(n=>splitNum(n.num)).filter(p=>p&&p.length===depth&&joinParts(p.slice(0,depth-1))===prefix).map(p=>p[depth-1]); }
  function childrenLastSegs(prefix,depth){ return loadNotes().map(n=>splitNum(n.num)).filter(p=>p&&p.length===depth+1&&joinParts(p.slice(0,depth))===prefix).map(p=>p[depth]); }
  const alphaToNum=s=>{let n=0; for(const ch of s){n=n*26+(ch.charCodeAt(0)-96)} return n}, numToAlpha=n=>{let s=''; while(n>0){const r=(n-1)%26; s=String.fromCharCode(97+r)+s; n=Math.floor((n-1)/26)} return s};
  function nextAlpha(segs){ if(!segs.length) return 'a'; let m=0; segs.forEach(x=>{ if(isAlpha(x)) m=Math.max(m,alphaToNum(x)); }); return numToAlpha(m+1); }
  function nextNumeric(segs){ if(!segs.length) return '1'; let m=0; segs.forEach(x=>{ if(isNum(x)) m=Math.max(m,parseInt(x,10)); }); return String(m+1); }
  function suggestChild(num){ const parts=splitNum(num); if(!parts) return ''; const prefix=joinParts(parts); const last=parts[parts.length-1]; const segs=childrenLastSegs(prefix,parts.length); const nxt=isNum(last)?nextAlpha(segs):nextNumeric(segs); return prefix+nxt; }
  function suggestSibling(num){ const p=splitNum(num); if(!p) return ''; const prefix=joinParts(p.slice(0,-1)); const last=p[p.length-1]; const segs=siblingsLastSegs(prefix,p.length); const nxt=isAlpha(last)?nextAlpha(segs):nextNumeric(segs); return prefix+nxt; }
  function nextRoot(){ const roots=loadNotes().map(n=>n.num).filter(p=>p&&/^\d+$/.test(p)).map(p=>parseInt(p,10)); const max=roots.length?Math.max(...roots):0; return String(max+1); }

  function notesForCurrentUser() {
    const all = (function(){ try { return JSON.parse(localStorage.getItem('willow_notes')||'[]'); } catch { return []; } })();
    const uid = window.currentUserId;
    const anyHasUser = all.some(n => 'userId' in n);
    if (!uid) return all;
    if (!anyHasUser) return all;
    return all.filter(n => n.userId === uid);
  }
  function computeTagStats() {
    const notes = notesForCurrentUser();
    const counts = new Map();
    for (const n of notes) for (const t of (n.tags || [])) counts.set(t, (counts.get(t) || 0) + 1);
    const entries = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
    const total = notes.length;
    if (entries.length === 0) return { most: [], least: [], total };
    const max = entries[0][1], min = entries[entries.length - 1][1];
    const most  = entries.filter(([_, c]) => c === max).map(([tag]) => tag);
    const least = entries.filter(([_, c]) => c === min).map(([tag]) => tag);
    return { most, least, total };
  }
  window.pushUserTagStats = async function pushUserTagStats() {
    try {
      const sb = window.__supa; const uid = window.currentUserId;
      if (!sb || !uid) return;
      const { most, least, total } = computeTagStats();
      const row = { user_id: uid, most_tags: most, least_tags: least, notes_count: total, updated_at: new Date().toISOString() };
      await sb.from('user_tag_stats').upsert(row, { onConflict: 'user_id' });
      window.dispatchEvent(new Event('willow-ready-stats'));
    } catch (e) { console.warn('[Willow] tag stats push failed:', e); }
  };

  let loadedId=null, placeMode=false, pendingAction=null, pendingFields=null;

  function refreshRecent(){
    const ul=$('#recentList');
    const items=loadNotes().sort((a,b)=>(a.updatedAt||a.createdAt||'')>(b.updatedAt||b.createdAt||'')?-1:1).slice(0,14);
    ul.innerHTML = items.length
      ? items.map(n=>`<li class="recent-item"><button class="linkbtn note-link" data-id="${escapeHtml(n.id)}"><strong>${escapeHtml(n.num||'‚Äî')}</strong> ‚Äî <span class="note-title">${escapeHtml(n.title)}</span></button> <span class="muted">(${n.published?'published':'draft'})</span></li>`).join('')
      : '<li class="muted">No notes yet.</li>';
    if(placeMode) $$('#recentList .recent-item').forEach(li=>li.classList.add('placeable'));
  }

  function gatherFields(){ return { title:$('[name="title"]').value.trim(), content:$('[name="content"]').value.trim(), tags:parseTags($('[name="tags"]').value), source:$('[name="source"]').value.trim() }; }
  function validateFields(f){ if(!f.title||!f.content) throw new Error('Title and Content are required.'); }
  function validateNumUnique(num, keepId){ /* no-op after ensureUniqueNum */ }
  // Auto-resolve duplicate Numbers by appending or incrementing a suffix
  function ensureUniqueNum(num, keepId){
    const existing = loadNotes().filter(n => n && n.num != null && n.id !== keepId).map(n => String(n.num));
    let candidate = String(num || '').trim();
    if (!candidate) candidate = "1";
    const baseMatch = candidate.match(/^(.*?)(?:-(\d+))?$/);
    let stem = baseMatch ? baseMatch[1] : candidate;
    let suffix = baseMatch && baseMatch[2] ? parseInt(baseMatch[2], 10) : 1;

    // If exact candidate already exists, bump suffix until free
    if (existing.includes(candidate)){
      // If candidate already has "-<num>", keep stem and bump from that number
      while (existing.includes(`${stem}-${suffix}`)) suffix++;
      candidate = `${stem}-${suffix}`;
    }
    return candidate;
  }
 already exists.`); }
  function upsertNote(note){ const list=loadNotes(); const i=list.findIndex(n=>n.id===note.id); if(i>=0) list[i]=note; else list.push(note); saveNotes(list); }
  function loadNoteIntoForm(id){ const n=loadNotes().find(x=>x.id===id); if(!n){showMsg('Note not found',false);return;} loadedId=n.id; $('#numInput').value=n.num||''; $('#hiddenKeepId').value='0'; $('[name="title"]').value=n.title||''; $('[name="content"]').value=n.content||''; $('[name="tags"]').value=(n.tags||[]).join(', '); $('[name="source"]').value=n.source||''; location.hash='#notetaker'; showMsg(`Loaded ${n.num}`,true); }
  function clearForm(){ $('#numInput').value=''; $('#hiddenKeepId').value='0'; $('[name="title"]').value=''; $('[name="content"]').value=''; $('[name="tags"]').value=''; $('[name="source"]').value=''; loadedId=null; }

  function togglePlacement(on){ placeMode=on; document.body.classList.toggle('place-mode',on); $$('#recentList .recent-item').forEach(li=>li.classList.toggle('placeable',on)); $('#newRootTarget').style.display=on?'block':'none'; $('#nextRootPreview').textContent=on?nextRoot():''; $('#placeBanner').style.display=on?'flex':'none'; }
  function beginPlacement(action, fields){ pendingAction=action; pendingFields=fields; togglePlacement(true); }
  function finishPlacementWith(num){
    $('#numInput').value = (ensureUniqueNum ? ensureUniqueNum(num, ($('#hiddenKeepId').value==='1'?loadedId:null)) : num);
    togglePlacement(false);
    if(pendingAction==='publish') finalizePublish(pendingFields,num);
    else if(pendingAction==='draft') finalizeDraft(pendingFields,num);
    pendingAction=null; pendingFields=null;
  }

  async function finalizeDraft(fields, num){
    try{
      validateFields(fields); validateNumUnique(num, $('#hiddenKeepId').value==='1'?loadedId:null);
      const id = (loadedId) ? loadedId : newUID();
      const note={ id, userId: window.currentUserId || null, num, ...fields, createdAt:now(), updatedAt:now(), published:false };
      upsertNote(note); loadedId=note.id;
      showMsg(`Draft saved (${note.num})`); refreshRecent(); renderGraph();
      await (window.pushUserTagStats?.()); clearForm(); location.hash='#notetaker'; document.querySelector('[name="title"]').focus();
    }catch(e){ showMsg(e.message||'Failed to save',false); }
  }
  async function finalizePublish(fields, num){
    try{
      validateFields(fields); validateNumUnique(num, $('#hiddenKeepId').value==='1'?loadedId:null);
      const id = (loadedId) ? loadedId : newUID();
      const note={ id, userId: window.currentUserId || null, num, ...fields, createdAt:now(), updatedAt:now(), published:true };
      upsertNote(note); loadedId=note.id;
      showMsg(`Published ‚úì (${note.num})`); refreshRecent(); await renderGraph();
      await (window.pushUserTagStats?.()); clearForm(); location.hash='#notetaker'; document.querySelector('[name="title"]').focus();
    }catch(e){ showMsg(e.message||'Failed to publish',false); }
  }
  async function draftSave(){ const num=$('#numInput').value.trim(), f=gatherFields(); try{ validateFields(f); if(!num){ beginPlacement('draft',f); return; } await finalizeDraft(f,num); } catch(e){ showMsg(e.message||'Failed to save',false); } }
  async function publish(e){ e.preventDefault(); const num=$('#numInput').value.trim(), f=gatherFields(); try{ validateFields(f); if(!num){ beginPlacement('publish',f); return; } await finalizePublish(f,num); } catch(err){ showMsg(err.message||'Failed to publish',false); } }
  function deleteLoaded(){ if(!loadedId){ showMsg('No loaded note to delete',false); return; } if(!confirm('Delete this note?')) return; saveNotes(loadNotes().filter(n=>n.id!==loadedId)); saveLinks(loadLinks().filter(e=> e.from!==loadedId && e.to!==loadedId)); clearForm(); refreshRecent(); renderGraph(); showMsg('Deleted',true); window.pushUserTagStats?.(); }

  document.getElementById('recentList').addEventListener('click',e=>{
    const btn=e.target.closest('.note-link'); if(!btn) return;
    const id=btn.getAttribute('data-id');
    if(placeMode){ const n=loadNotes().find(x=>x.id===id); if(!n) return; const sug=suggestChild(n.num)||( /^\d+$/.test(n.num)?n.num+'a':n.num+'1'); finishPlacementWith(sug); return; }
    loadNoteIntoForm(id);
  });
  document.getElementById('placeNewRoot').addEventListener('click',()=>finishPlacementWith(nextRoot()));
  document.getElementById('newNoteBtn').onclick=()=>{ location.hash='#notetaker'; clearForm(); document.querySelector('[name="title"]').focus(); };
  document.getElementById('saveDraft').onclick=draftSave;
  document.getElementById('noteForm').onsubmit=publish;
  document.getElementById('deleteNote').onclick=deleteLoaded;
  document.getElementById('clearAll').onclick=()=>{ localStorage.removeItem(LS_NOTES); localStorage.removeItem(LS_LINKS); localStorage.removeItem('willow_blindspot_seeds'); localStorage.removeItem('willow_embed_cache'); clearForm(); refreshRecent(); renderGraph(); window.pushUserTagStats?.(); };

  const svg=document.getElementById('kg'), vp=document.getElementById('vp'); const view={x:0,y:0,k:1}, W=800,H=450;
  function applyTransform(){ vp.setAttribute('transform',`translate(${view.x} ${view.y}) scale(${view.k})`); }
  function resetView(){ view.x=0; view.y=0; view.k=1; applyTransform(); }

  function animateView(target, ms=350){
    const start = { x:view.x, y:view.y, k:view.k };
    const t0 = performance.now();
    function step(t){
      const p = Math.min(1,(t-t0)/ms);
      const e = 0.5 - Math.cos(p*Math.PI)/2;
      view.x = start.x + (target.x - start.x)*e;
      view.y = start.y + (target.y - start.y)*e;
      view.k = start.k + (target.k - start.k)*e;
      applyTransform();
      if (p<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  svg.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const rect=svg.getBoundingClientRect(); const mx=e.clientX-rect.left, my=e.clientY-rect.top;
    const ptX=(mx - view.x)/view.k, ptY=(my - view.y)/view.k;
    const delta=-Math.sign(e.deltaY)*0.12;
    const k=Math.min(5,Math.max(0.5, view.k*(1+delta)));
    view.x = mx - ptX*k; view.y = my - ptY*k; view.k = k; applyTransform();
  }, {passive:false});
  let dragging=false,last={x:0,y:0};
  svg.addEventListener('mousedown',(e)=>{dragging=true;last.x=e.clientX;last.y=e.clientY;});
  window.addEventListener('mousemove',(e)=>{if(!dragging)return; const dx=e.clientX-last.x, dy=e.clientY-last.y; view.x+=dx; view.y+=dy; last.x=e.clientX; last.y=e.clientY; applyTransform();});
  window.addEventListener('mouseup',()=>{dragging=false;});
  svg.addEventListener('dblclick',()=> resetView());

  const AXIS_RIGHT='housing', AXIS_LEFT='technology', AXIS_UP='policy', AXIS_DOWN='energy';

  async function vectorLayout(nodes){
    const api = window.__willow_embedder;
    if (!api) return null;
    const e = await api.ensureEmbedder();

    let cache = {};
    try { cache = JSON.parse(localStorage.getItem('willow_embed_cache')||'{}'); } catch {}

    async function embText(key, text){
      const ck = `axis:${key}`;
      if (cache[ck]) return cache[ck];
      const out = await e(text, { pooling:'mean', normalize:true });
      const vec = Array.from(out.data || out);
      cache[ck] = vec; localStorage.setItem('willow_embed_cache', JSON.stringify(cache));
      return vec;
    }
    async function embNote(n){
      const ck = `note:${n.id}:${n.updatedAt||n.createdAt||''}`;
      if (cache[ck]) return cache[ck];
      const out = await e(n.content||n.title||'', { pooling:'mean', normalize:true });
      const vec = Array.from(out.data || out);
      cache[ck] = vec; localStorage.setItem('willow_embed_cache', JSON.stringify(cache));
      return vec;
    }
    const vR = await embText('right', AXIS_RIGHT);
    const vL = await embText('left',  AXIS_LEFT);
    const vU = await embText('up',    AXIS_UP);
    const vD = await embText('down',  AXIS_DOWN);

    function norm(a){ const s=Math.sqrt(a.reduce((q,x)=>q+x*x,0))||1; return a.map(x=>x/s); }
    function sub(a,b){ return a.map((x,i)=>x-b[i]); }
    function dot(a,b){ let s=0; for(let i=0;i<a.length;i++) s+=a[i]*b[i]; return s; }

    const axisX = norm(sub(vR, vL));
    const axisY = norm(sub(vU, vD));

    const coords = [];
    for (const n of nodes) {
      const v = await embNote(n);
      const x = dot(v, axisX);
      const y = dot(v, axisY);
      coords.push({ id:n.id, x, y });
    }
    const xs = coords.map(c=>c.x), ys=coords.map(c=>c.y);
    const xmin=Math.min(...xs), xmax=Math.max(...xs), ymin=Math.min(...ys), ymax=Math.max(...ys);
    const dx = (xmax-xmin)||1, dy=(ymax-ymin)||1;
    coords.forEach(c=>{ c.x = ((c.x - xmin)/dx)*2 - 1; c.y = ((c.y - ymin)/dy)*2 - 1; });
    return coords;
  }

  function circleLayout(n,cx,cy,r){ if(n<=1)return[{x:cx,y:cy}]; const pts=[]; for(let i=0;i<n;i++){const a=(2*Math.PI*i)/n-Math.PI/2; pts.push({x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)})} return pts; }
  const shareTags=(a=[],b=[])=>a.some(t=>b.includes(t));

  async function renderGraph(){
    const vpEl = vp; vpEl.innerHTML=''; const nodes=loadNotes().filter(n=>n.published), links=loadLinks();
    document.getElementById('statNodes').textContent=String(nodes.length);
    if(nodes.length===0){ vpEl.insertAdjacentHTML('beforeend','<text x="400" y="210" text-anchor="middle">No published notes yet</text>'); svg.onclick=null; return; }

    let posMap = new Map();
    try {
      if (window.__willow_embedder) {
        const coords = await vectorLayout(nodes);
        if (coords) {
          const pad = 40, cx = W/2, cy=H/2, rx=(W/2 - pad), ry=(H/2 - pad);
          for (const c of coords) posMap.set(c.id, { x: cx + c.x*rx, y: cy - c.y*ry });
        }
      }
    } catch(e){ console.warn('[Willow] vector layout failed, using circle', e); }

    if (posMap.size===0) {
      const pts=circleLayout(nodes.length, W/2, H/2, Math.min(320,180+Math.max(0,12-nodes.length)*8));
      nodes.forEach((n,i)=>posMap.set(n.id, pts[i]));
    }

    let tagEdges=0;
    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        if(shareTags(nodes[i].tags,nodes[j].tags)){
          const a=posMap.get(nodes[i].id), b=posMap.get(nodes[j].id);
          vpEl.insertAdjacentHTML('beforeend',`<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="#cbd5e1"/>`); tagEdges++;
        }
      }
    }
    document.getElementById('statEdges').textContent=String(tagEdges);

    let linkEdges=0;
    const publishedIds=new Set(nodes.map(n=>n.id));
    links.forEach(e=>{
      if(!publishedIds.has(e.from)||!publishedIds.has(e.to)) return;
      const a=posMap.get(e.from), b=posMap.get(e.to);
      vpEl.insertAdjacentHTML('beforeend',`<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="#64748b" class="edge-dashed"/>`); linkEdges++;
    });
    document.getElementById('statEdgesLinks').textContent=String(linkEdges);

    nodes.forEach(n=>{
      const p=posMap.get(n.id);
      const idAttr='node-'+n.id.replace(/[^a-zA-Z0-9_-]/g,'_');
      const label=(n.title||'Untitled').replace(/[&<>\"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
      const titleAttr=(n.num||'‚Äî')+' ‚Äî '+(n.title||'')+'\nTags: '+((n.tags||[]).join(', ')||'‚Äî');
      vpEl.insertAdjacentHTML('beforeend',`<g id="${idAttr}" data-id="${n.id}"><circle cx="${p.x}" cy="${p.y}" r="12" fill="#6366f1"></circle><text x="${p.x}" y="${p.y+26}" text-anchor="middle">${label}</text><title>${titleAttr}</title></g>`);
    });

    svg.onclick=(e)=>{
      let el=e.target;
      while(el && el!==svg && !(el.tagName && el.tagName.toLowerCase()==='g' && el.dataset && el.dataset.id)){ el=el.parentNode; }
      if(!el||!el.dataset||!el.dataset.id) return; const id=el.dataset.id;
      if(placeMode){ const n=loadNotes().find(x=>x.id===id); if(!n) return; const sug=suggestChild(n.num)||( /^\d+$/.test(n.num)?n.num+'a':n.num+'1'); finishPlacementWith(sug); return; }
      loadNoteIntoForm(id);
    };

    fitToContent(true);
  }

  function fitToContent(animated=false){
    const circles=[...vp.querySelectorAll('circle')];
    if(!circles.length){ animateView({x:0,y:0,k:1}); return; }
    let xmin=Infinity,xmax=-Infinity,ymin=Infinity,ymax=-Infinity;
    for(const c of circles){
      const x=+c.getAttribute('cx'), y=+c.getAttribute('cy'); const r=+c.getAttribute('r')+30;
      xmin=Math.min(xmin,x-r); xmax=Math.max(xmax,x+r); ymin=Math.min(ymin,y-r); ymax=Math.max(ymax,y+r);
    }
    const vw=W, vh=H, bw=xmax-xmin, bh=ymax-ymin;
    const k = Math.max(0.5, Math.min(4, 0.95*Math.min(vw/bw, vh/bh)));
    const x = (vw/2) - (xmin + bw/2)*k;
    const y = (vh/2) - (ymin + bh/2)*k;
    if (animated) animateView({x,y,k}, 450); else { view.x=x; view.y=y; view.k=k; applyTransform(); }
  }

  let lastHash = location.hash;
  window.addEventListener('hashchange', ()=>{
    if (lastHash === '#graph' && location.hash !== '#graph') {
      const badZoom = (view.k < 0.6 || view.k > 3.2);
      if (badZoom) fitToContent(true);
    }
    lastHash = location.hash;
  });

  document.getElementById('rebuild').onclick=()=>renderGraph();
  document.getElementById('fitView').onclick=()=>fitToContent(true);

  (function migrate(){ const notes=loadNotes(); let changed=false; notes.forEach(n=>{ if(!n.id){n.id=newUID();changed=true;} }); if(changed) saveNotes(notes); })();

  refreshRecent(); renderGraph();
</script>


<script>
      // ===== Willow Finance LLM client (Hugging Face backend) =====
      // Expects a FastAPI server with POST /v1/chat that returns { text }
      (function(){
        const ui = {
          tabs: Array.from(document.querySelectorAll('#agentsCard .btn[data-tab]')),
          panels: Array.from(document.querySelectorAll('.agent-panel')),
          chats: {
            interconnectedness: document.getElementById('chat-interconnectedness'),
            historian: document.getElementById('chat-historian'),
            blind_spot: document.getElementById('chat-blind_spot')
          },
          inputs: {
            interconnectedness: document.getElementById('inp-interconnectedness'),
            historian: document.getElementById('inp-historian'),
            blind_spot: document.getElementById('inp-blind_spot')
          }
        };

        const agents = {
          interconnectedness: {
            system: (ctx) => `You are the Interconnectedness Agent. Task: reveal concrete linkages between the user's current atomic note and other domains.
- Be specific and concise. Prefer 1‚Äì2 focused relationships with mechanism and WHY it matters now.
- Propose ONE candidate note text: include a 'Title:' line and 2‚Äì5 sentences as the body; mirror the user's writing style.
- Avoid boilerplate. Use the note‚Äôs tags and vocabulary.
Context:
${ctx}`
          },
          historian: {
            system: (ctx) => `You are the Historian Agent. You will use the users note and give historical background with dates and proper notation on it's implication.
- Give 1‚Äì2 analogs with parallels and contrasts; finish with what to watch.
- Offer ONE candidate note: include a 'Title:' line and 2‚Äì5 sentences body in the user's style.
Context:
${ctx}`
          },
          blind_spot: {
            system: (ctx) => `You are the Blind-Spot Agent. Introduce an orthogonal angle‚Äîsomething the user likely isn't tracking.
- Do NOT reference existing note titles; invent a fresh, distinct topic about the financial system in some way.
- Provide one actionable hypothesis and one falsifier about this financial topic.
- Offer ONE candidate note: include a 'Title:' line and 2‚Äì5 sentences body in the user's style.
Context:
${ctx}`
          }
        };

        const history = {
          interconnectedness: [],
          historian: [],
          blind_spot: []
        };

        function addBubble(agent, who, text){
          const chat = ui.chats[agent];
          const div = document.createElement('div');
          div.className = 'bubble ' + (who==='user'?'user':'bot');
          div.textContent = text;
          chat.appendChild(div);
          chat.scrollTop = chat.scrollHeight;
        }
        function addStreamingBubble(agent){
          const chat = ui.chats[agent];
          const div = document.createElement('div');
          div.className = 'bubble bot';
          div.textContent = '';
          chat.appendChild(div);
          chat.scrollTop = chat.scrollHeight;
          return {
            append(t){ div.textContent += t; chat.scrollTop = chat.scrollHeight; },
            get text(){ return div.textContent; },
            set text(v){ div.textContent = v; chat.scrollTop = chat.scrollHeight; }
          };
        }

        ui.tabs.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const tab = btn.dataset.tab;
            ui.panels.forEach(p=>p.style.display = (p.dataset.panel===tab)?'block':'none');
          });
        });

        function currentNoteContext(){
          const form = document.getElementById('noteForm');
          const title = form?.elements?.title?.value?.trim() || '';
          const content = form?.elements?.content?.value?.trim() || '';
          const tags = (form?.elements?.tags?.value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
          const recents = [...document.querySelectorAll('#recentList li .note-title')].slice(0,6).map(n=>n.textContent.trim());
          return `Title: ${title || '(untitled)'}
Tags: ${tags.join(', ')||'(none)'}
Body: ${content.slice(0,1200)}
Recent note titles: ${recents.join(' | ')||'(none)'}`;
        }

        async function llmChat(messages, temperature){
  const base = (window.WILLOW_HF_BASE || 'https://router.huggingface.co/v1').replace(/\/$/, '');
  const model = window.WILLOW_HF_MODEL || 'HuggingFaceTB/SmolLM3-3B:hf-inference';
  const token = window.WILLOW_HF_TOKEN;
  const res = await fetch(base + '/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({
      model,
      messages: messages.map(m => ({ role: m.role, content: m.content })),
      temperature: (temperature ?? 0.7),
      max_tokens: 512
    })
  });
  if(!res.ok){
    const errText = await res.text();
    throw new Error('HF router error ' + res.status + ': ' + errText);
  }
  const data = await res.json();
  let text = data?.choices?.[0]?.message?.content || data?.text || '';
  return text;
},
            body: JSON.stringify({ messages, temperature: temperature ?? 0.7 })
          });
          if (!res.ok) throw new Error('LLM API error ' + res.status);
          const data = await res.json();
          // Expect { text: "..." } or OpenAI-style { choices:[{message:{content}}] }
          let text = data?.text;
          if (!text && data?.choices?.[0]?.message?.content) text = data.choices[0].message.content;
          return text || '';
        }

        async function sendAgent(agentKey){
          const input = ui.inputs[agentKey];
          const userText = (input.value || '').trim() || '.';
          input.value = '';

          const ctx = currentNoteContext();
          const sys = agents[agentKey].system(ctx);
          if (history[agentKey].length === 0) history[agentKey].push({ role:'system', content: sys });
          history[agentKey].push({ role:'user', content: userText });

          addBubble(agentKey,'user', userText);
          const stream = addStreamingBubble(agentKey);

          try {
            const reply = await llmChat(history[agentKey], agentKey==='blind_spot' ? 1.1 : 0.8);
            stream.text = reply;
            history[agentKey].push({ role:'assistant', content: reply });
          } catch (e) {
            console.error(e);
            stream.append('\n[Error generating reply]');
          }
        }

        function extractTags(s){
          const words = (String(s).toLowerCase().match(/[a-z][a-z\-]{2,}/g)||[]).filter(w=>!['this','that','with','from','into','about','their','there','which','because','while','among','between','also','only','these','those','over','under','after','before','against','within','without','could','should','would','might','analog','history','historian','orthogonal'].includes(w));
          const freq = new Map(); words.forEach(w=>freq.set(w,(freq.get(w)||0)+1));
          return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(([w])=>w);
        }

        function splitTitleBody(full){
          let title = 'AI suggestion';
          let body = String(full).trim();
          const m = body.match(/^\s*Title\s*:\s*(.+)$/mi);
          if (m) { title = m[1].trim(); body = body.replace(m[0],'').trim(); }
          else {
            const firstPeriod = body.indexOf('. ');
            if (firstPeriod>20 && firstPeriod<140) { title = body.slice(0, firstPeriod+1); body = body.slice(firstPeriod+1).trim(); }
          }
          return { title, body };
        }

        function sendToNotetakerFrom(agentKey){
          const chat = ui.chats[agentKey];
          const lastBot = [...chat.querySelectorAll('.bubble.bot')].pop();
          if (!lastBot) { alert('No assistant message yet.'); return; }
          const full = lastBot.textContent.trim();
          const { title, body } = splitTitleBody(full);
          const form = document.getElementById('noteForm');
          form.elements.title.value = title;
          form.elements.content.value = body;
          const baseTags = (form.elements.tags.value||'').split(',').map(s=>s.trim()).filter(Boolean);
          const auto = Array.from(new Set(baseTags.concat(extractTags(full)).slice(0,6)));
          form.elements.tags.value = auto.join(', ');
          form.elements.title.focus();
        }

        function acceptToPlacement(agentKey){
          const chat = ui.chats[agentKey];
          const lastBot = [...chat.querySelectorAll('.bubble.bot')].pop();
          if (!lastBot) { alert('No assistant message yet.'); return; }
          const full = lastBot.textContent.trim();
          const { title, body } = splitTitleBody(full);
          const tags = extractTags(full);
          const fields = { title, content: body, tags, source: '' };
          if (window.beginPlacement) {
            window.beginPlacement('publish', fields);
            document.getElementById('recentList')?.scrollIntoView({ behavior:'smooth', block:'center' });
          } else {
            sendToNotetakerFrom(agentKey);
          }
        }

        for (const [agent, inputEl] of Object.entries(ui.inputs)) {
          const sendBtn = document.querySelector(`button[data-send="${agent}"]`);
          sendBtn?.addEventListener('click', ()=> sendAgent(agent));
          inputEl?.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); sendAgent(agent); }});
          const toNoteBtn = document.querySelector(`button[data-to-note="${agent}"]`);
          toNoteBtn?.addEventListener('click', ()=> sendToNotetakerFrom(agent));
          const acceptBtn = document.querySelector(`button[data-accept="${agent}"]`);
          acceptBtn?.addEventListener('click', ()=> acceptToPlacement(agent));
        }

        // Expose helpers if needed elsewhere
        window.__willow_agents = { sendAgent, sendToNotetakerFrom, acceptToPlacement };
      })();
    </script>
</body>
</html>
