<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Willow â€” Admin</title>
<style>
  :root { --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#4f46e5; --bg:#f8fafc; --danger:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  .wrap{max-width:1000px;margin:0 auto;padding:20px 16px 60px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
  textarea{resize:vertical;min-height:90px}
  button{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.danger{border-color:var(--danger);color:#ef4444}
  .pill{font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#64748b}
  .muted{color:#64748b;font-size:12px}
  .prop-card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between;">
    <div class="row" style="gap:10px;"><div style="font-size:22px;">ðŸŒ¿</div><strong>Willow Admin</strong></div>
    <a href="index.html">Back to app</a>
  </div>

  <!-- Password gate -->
  <div id="gate" class="card" style="margin-top:12px;">
    <strong>Admin access</strong>
    <p class="muted">Enter admin password to manage forecasts.</p>
    <div class="row">
      <input id="pw" type="password" placeholder="admin">
      <button id="go" class="btn primary">Enter</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <!-- Admin panel -->
  <div id="panel" style="display:none;">
    <div class="card" style="margin-top:12px;">
      <div class="row">
        <input id="fcTitle" placeholder="Question (binary)" style="flex:1">
        <input id="fcClose" type="date" title="Close date">
        <button class="btn primary" id="fcCreate">New forecast</button>
      </div>
      <textarea id="fcCriteria" placeholder="Resolution criteria (who/what/when/how)"></textarea>
      <div class="muted" id="fcSyncMsg" style="margin-top:6px;"></div>
    </div>
    <div id="fcList" style="margin-top:12px;"></div>

    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;">
        <strong>AI Suggestions from Popular Tags</strong>
        <button class="btn primary" id="genSuggest">Generate</button>
      </div>
      <div id="suggestionsBox" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<script>
  window.WILLOW_CFG = window.WILLOW_CFG || {
    url: 'https://seolktqxdxstwqdiqzke.supabase.co',
    anon: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlb2xrdHF4ZHhzdHdxZGlxemtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjc0MjAsImV4cCI6MjA3MDk0MzQyMH0.Qt6wLLfR1QxbYGpq42t1uwpy5kDdqb_LN5-JA89Fj-U'
  };
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const { url, anon } = window.WILLOW_CFG;

  // --- FIX: ensure apikey is always present on /rest/v1/ requests ---
  const originHost = new URL(url).host;
  const withApiKeyQuery = async (input, init) => {
    const reqUrl = typeof input === 'string' ? input : input.url;
    try {
      const u = new URL(reqUrl);
      if (u.host === originHost && u.pathname.includes('/rest/v1/')) {
        if (!u.searchParams.has('apikey')) u.searchParams.set('apikey', anon);
      }
      return fetch(u.toString(), init);
    } catch {
      return fetch(input, init);
    }
  };

  window.__supa = window.__supa || createClient(url, anon, {
    auth: { persistSession: true, autoRefreshToken: true },
    global: {
      headers: { apikey: anon, Authorization: `Bearer ${anon}` },
      fetch: withApiKeyQuery
    }
  });
</script>

<script>
  const gate = document.getElementById('gate');
  const panel = document.getElementById('panel');
  const gateMsgEl = document.getElementById('msg');
  function openPanel(){
    gate.style.display='none';
    panel.style.display='block';
    localStorage.setItem('willow_admin_ok','1');
  }
  document.getElementById('go').addEventListener('click', ()=>{
    const v = (document.getElementById('pw').value||'').trim();
    if (v === 'admin') openPanel();
    else { gateMsgEl.textContent='Wrong password'; gateMsgEl.className='pill'; }
  });
  if (localStorage.getItem('willow_admin_ok') === '1') openPanel();
</script>

<script>
const LS_FC = 'willow_forecasts';
const loadForecasts = () => { try { return JSON.parse(localStorage.getItem(LS_FC) || '[]'); } catch { return []; } };
const saveForecasts = (arr) => localStorage.setItem(LS_FC, JSON.stringify(arr));
const clamp = (x,a=0.001,b=0.999) => Math.min(b, Math.max(a, x));
const logit = (p) => Math.log(p/(1-p));
const invLogit = (L) => 1/(1+Math.exp(-L));
function aggregateLogOdds(updates, now=Date.now(), halfLifeDays=14, extremize=1.3) {
  if (!updates?.length) return null;
  const HL = halfLifeDays * 864e5; let num=0, den=0;
  for (const u of updates) {
    const t = (typeof u.t === 'string') ? new Date(u.t).getTime() : +u.t;
    const w = Math.exp(-(now - t)/HL);
    const L = logit(clamp(u.p));
    num += w * L; den += w;
  }
  if (den === 0) return null;
  return invLogit((num/den) * extremize);
}
function renderSparkline(values, w=120, h=28) {
  if (!values?.length) return `<svg width="${w}" height="${h}"></svg>`;
  const min=0, max=1, step=w/(values.length-1||1);
  const pts = values.map((p,i)=>`${(i*step).toFixed(1)},${(h - (p-min)/(max-min)*h).toFixed(1)}`).join(' ');
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline fill="none" stroke="#4f46e5" stroke-width="2" points="${pts}"/></svg>`;
}
function newForecastId() { const d=new Date(); return `F-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${Math.random().toString(36).slice(2,8)}`; }
function renderForecastCard(f){
  const values = (f.updates||[]).map(u=>u.p);
  const pStar = aggregateLogOdds(f.updates||[]) ?? (values.length ? values[values.length-1] : 0.5);
  const pct = Math.round((pStar||0.5)*100);
  const status = f.status || 'open';
  const open = status === 'open';
  const closed = status === 'closed';
  return `
  <div class="card" data-fid="${f.id}">
    <div class="row
