<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Willow â€” Admin</title>
<style>
  :root { --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#4f46e5; --bg:#f8fafc; --danger:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  .wrap{max-width:1000px;margin:0 auto;padding:20px 16px 60px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
  textarea{resize:vertical;min-height:90px}
  button{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.danger{border-color:var(--danger);color:#ef4444}
  .pill{font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#64748b}
  .muted{color:#64748b;font-size:12px}
  .prop-card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between;">
    <div class="row" style="gap:10px;"><div style="font-size:22px;">ðŸŒ¿</div><strong>Willow Admin</strong></div>
    <a href="index.html">Back to app</a>
  </div>

  <!-- Password gate -->
  <div id="gate" class="card" style="margin-top:12px;">
    <strong>Admin access</strong>
    <p class="muted">Enter admin password to manage forecasts.</p>
    <div class="row">
      <input id="pw" type="password" placeholder="admin">
      <button id="go" class="btn primary">Enter</button>
      <span id="msg" class="muted"></span>
    </div>
  </div>

  <!-- Admin panel -->
  <div id="panel" style="display:none;">
    <div class="card" style="margin-top:12px;">
      <div class="row">
        <input id="fcTitle" placeholder="Question (binary)" style="flex:1">
        <input id="fcClose" type="date" title="Close date">
        <button class="btn primary" id="fcCreate">New forecast</button>
      </div>
      <textarea id="fcCriteria" placeholder="Resolution criteria (who/what/when/how)"></textarea>
      <div class="muted" id="fcSyncMsg" style="margin-top:6px;"></div>
    </div>
    <div id="fcList" style="margin-top:12px;"></div>

    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;">
        <strong>AI Suggestions from Popular Tags</strong>
        <button class="btn primary" id="genSuggest">Generate</button>
      </div>
      <div id="suggestionsBox" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<script>
  window.WILLOW_CFG = window.WILLOW_CFG || {
    url: 'https://seolktqxdxstwqdiqzke.supabase.co',
    anon: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlb2xrdHF4ZHhzdHdxZGlxemtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjc0MjAsImV4cCI6MjA3MDk0MzQyMH0.Qt6wLLfR1QxbYGpq42t1uwpy5kDdqb_LN5-JA89Fj-U'
  };
</script>

<!-- Supabase client with headers -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const { url, anon } = window.WILLOW_CFG;
  window.__supa = window.__supa || createClient(url, anon, {
    auth: { persistSession: true, autoRefreshToken: true },
    global: { headers: { apikey: anon, Authorization: `Bearer ${anon}` } }
  });
</script>

<!-- Admin gate (classic script; doesn't need Supabase) -->
<script>
  const gate = document.getElementById('gate');
  const panel = document.getElementById('panel');
  const gateMsgEl = document.getElementById('msg');

  function openPanel(){
    gate.style.display='none';
    panel.style.display='block';
    localStorage.setItem('willow_admin_ok','1');
  }

  document.getElementById('go').addEventListener('click', ()=>{
    const v = (document.getElementById('pw').value||'').trim();
    if (v === 'admin') openPanel();
    else { gateMsgEl.textContent='Wrong password'; gateMsgEl.className='pill'; }
  });

  if (localStorage.getItem('willow_admin_ok') === '1') openPanel();
</script>

<!-- Forecast core (admin UI only; local store) -->
<script>
const LS_FC = 'willow_forecasts';
const loadForecasts = () => { try { return JSON.parse(localStorage.getItem(LS_FC) || '[]'); } catch { return []; } };
const saveForecasts = (arr) => localStorage.setItem(LS_FC, JSON.stringify(arr));
const clamp = (x,a=0.001,b=0.999) => Math.min(b, Math.max(a, x));
const logit = (p) => Math.log(p/(1-p));
const invLogit = (L) => 1/(1+Math.exp(-L));
function aggregateLogOdds(updates, now=Date.now(), halfLifeDays=14, extremize=1.3) {
  if (!updates?.length) return null;
  const HL = halfLifeDays * 864e5; let num=0, den=0;
  for (const u of updates) {
    const t = (typeof u.t === 'string') ? new Date(u.t).getTime() : +u.t;
    const w = Math.exp(-(now - t)/HL);
    const L = logit(clamp(u.p));
    num += w * L; den += w;
  }
  if (den === 0) return null;
  return invLogit((num/den) * extremize);
}
function brier(p, outcomeYes) { const y = outcomeYes ? 1 : 0; return (clamp(p) - y) ** 2; }
function newForecastId() { const d=new Date(); return `F-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${Math.random().toString(36).slice(2,8)}`; }
function upsertForecastLocal(f){ const all=loadForecasts(); const i=all.findIndex(x=>x.id===f.id); if(i>=0) all[i]=f; else all.push(f); saveForecasts(all); return f; }
function renderSparkline(values, w=120, h=28) {
  if (!values?.length) return `<svg width="${w}" height="${h}"></svg>`;
  const min=0, max=1, step=w/(values.length-1||1);
  const pts = values.map((p,i)=>`${(i*step).toFixed(1)},${(h - (p-min)/(max-min)*h).toFixed(1)}`).join(' ');
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline fill="none" stroke="#4f46e5" stroke-width="2" points="${pts}"/></svg>`;
}
function renderForecastCard(f, votesById){
  const values = (f.updates||[]).map(u=>u.p);
  const pStar = aggregateLogOdds(f.updates||[]) ?? (values.length ? values[values.length-1] : 0.5);
  const pct = Math.round((pStar||0.5)*100);
  const votes = (votesById && votesById.get(f.id)) ? votesById.get(f.id).length : 0;
  const status = f.status || 'open';
  const closed = status === 'closed';
  const open = status !== 'resolved';
  return `
  <div class="card" data-fid="${f.id}">
    <div class="row" style="justify-content:space-between;">
      <div>
        <strong>${f.title}</strong>
        <div class="muted">${f.resolution_criteria||''}</div>
        <div class="muted">Status: ${status}${f.closeAt?`, closes: ${new Date(f.closeAt).toLocaleDateString()}`:''} Â· Votes: ${votes}</div>
      </div>
      <div>${renderSparkline(values)}</div>
    </div>
    ${status === 'resolved' ? `
      <div class="row" style="margin-top:6px;">
        <span class="pill">Resolved: ${f.resolution?.outcome}</span>
        <span class="pill">Brier: ${f.metrics?.brier?.toFixed(3) ?? '-'}</span>
      </div>
    ` : `
      <div class="row" style="margin-top:10px;align-items:center;">
        <input type="range" min="1" max="99" value="${pct}" class="fcProb" style="flex:1">
        <span class="pill fcProbLabel" style="min-width:48px;text-align:center;">${pct}%</span>
        <button class="btn" data-q="5">5%</button><button class="btn" data-q="10">10%</button>
        <button class="btn" data-q="20">20%</button><button class="btn" data-q="40">40%</button>
        <button class="btn" data-q="60">60%</button><button class="btn" data-q="80">80%</button>
        <button class="btn" data-q="90">90%</button><button class="btn" data-q="95">95%</button>
      </div>
      <textarea class="fcWhy" placeholder="Rationale / links to notesâ€¦"></textarea>
      <div class="row" style="margin-top:8px;">
        <button class="btn primary fcUpdate" ${closed?'disabled':''}>Update</button>
        <button class="btn fcClose" ${closed?'disabled':''}>Close</button>
        <button class="btn danger fcResolveYes" ${open?'':'disabled'}>Resolve YES</button>
        <button class="btn danger fcResolveNo" ${open?'':'disabled'}>Resolve NO</button>
      </div>
    `}
  </div>`;
}
function refreshForecastList(votesById){
  const box = document.getElementById('fcList');
  const arr = loadForecasts().sort((a,b)=>(a.status==='open'?0:1)-(b.status==='open'?0:1));
  box.innerHTML = arr.length ? arr.map(f=>renderForecastCard(f, votesById||new Map())).join('') : '<div class="muted">No forecasts yet.</div>';

  box.querySelectorAll('.card[data-fid]').forEach(card=>{
    const id = card.getAttribute('data-fid');
    const slider = card.querySelector('.fcProb');
    const label  = card.querySelector('.fcProbLabel');
    const why    = card.querySelector('.fcWhy');

    if (slider && label) slider.addEventListener('input', ()=>label.textContent = slider.value + '%');
    card.querySelectorAll('[data-q]').forEach(btn=>{
      btn.addEventListener('click',()=>{ if(!slider||!label) return; slider.value=btn.getAttribute('data-q'); label.textContent=slider.value+'%'; });
    });

    card.querySelector('.fcUpdate')?.addEventListener('click', async ()=>{
      const all = loadForecasts(); const f = all.find(x=>x.id===id); if(!f) return;
      const p = (slider? Number(slider.value)/100 : 0.5);
      const rationale = (why? why.value.trim() : '');
      (f.updates ||= []).push({ t: new Date().toISOString(), p, rationale, by: 'admin' });
      f.updated_at = new Date().toISOString();
      upsertForecastLocal(f); await pushForecastToServer(f); refreshForecastList();
    });

    card.querySelector('.fcClose')?.addEventListener('click', async ()=>{
      const all = loadForecasts(); const f = all.find(x=>x.id===id); if(!f) return;
      f.status = 'closed'; f.updated_at = new Date().toISOString();
      upsertForecastLocal(f); await pushForecastToServer(f); refreshForecastList();
    });

    const doResolve = async (outcomeYes) => {
      const all = loadForecasts(); const f = all.find(x=>x.id===id); if(!f) return;
      const pStar = aggregateLogOdds(f.updates||[]) ?? (f.updates?.length ? f.updates[f.updates.length-1].p : 0.5);
      const score = brier(pStar, outcomeYes);
      f.status = 'resolved';
      f.resolution = { outcome: outcomeYes?'YES':'NO', t: new Date().toISOString(), comment: '' };
      f.metrics = { brier: score };
      f.updated_at = new Date().toISOString();
      upsertForecastLocal(f); await pushForecastToServer(f); refreshForecastList();
    };
    card.querySelector('.fcResolveYes')?.addEventListener('click', ()=>doResolve(true));
    card.querySelector('.fcResolveNo')?.addEventListener('click', ()=>doResolve(false));
  });
}
document.getElementById('fcCreate')?.addEventListener('click', async ()=>{
  const title = document.getElementById('fcTitle').value.trim(); if (!title) return alert('Enter a question');
  const crit = document.getElementById('fcCriteria').value.trim();
  const close = document.getElementById('fcClose').value ? new Date(document.getElementById('fcClose').value).toISOString() : null;
  const f = { id:newForecastId(), title, resolution_criteria:crit, closeAt:close, resolveBy:null, status:'open', tags:[], linkedNoteIds:[], updates:[], metrics:{}, resolution:null, updated_at:new Date().toISOString() };
  upsertForecastLocal(f); await pushForecastToServer(f);
  document.getElementById('fcTitle').value=''; document.getElementById('fcCriteria').value=''; document.getElementById('fcClose').value='';
  refreshForecastList();
});
</script>

<!-- Supabase sync (admin) -->
<script type="module">
  const sb = window.__supa;
  const syncMsgEl = document.getElementById('fcSyncMsg');
  const setSync = (t)=>{ if(syncMsgEl) syncMsgEl.textContent=t; };

  async function pullForecastsFromServer(){
    const { data, error } = await sb.from('forecasts').select('*').order('updated_at', { ascending: true });
    if(error){ console.warn('[Willow] pull error', error); setSync('Cloud sync: error.'); return; }
    const local = (function(){ try { return JSON.parse(localStorage.getItem('willow_forecasts')||'[]'); } catch { return []; } })();
    const map=new Map(local.map(f=>[f.id,f]));
    for(const r of data){ const l=map.get(r.id); if(!l || new Date(r.updated_at||0) > new Date(l.updated_at||0)) map.set(r.id, r); }
    localStorage.setItem('willow_forecasts', JSON.stringify([...map.values()]));
    setSync('Cloud sync: up to date.');
    try { if(typeof refreshForecastList==='function') refreshForecastList(); } catch {}
  }

  window.pushForecastToServer = async function(f){
    try {
      const { error } = await sb.from('forecasts').upsert(f, { onConflict: 'id' });
      if(error){ console.warn('[Willow] upsert error', error); setSync('Cloud sync: upsert error.'); }
      else setSync('Cloud sync: saved.');
    } catch (e) { console.warn('[Willow] push failed', e); setSync('Cloud sync: offline.'); }
  };

  async function pullVotes(){
    const { data, error } = await sb.from('forecast_votes').select('*');
    if (error) { console.warn('[Willow] pull votes error', error); return new Map(); }
    const map = new Map();
    (data||[]).forEach(v=>{ if(!map.has(v.forecast_id)) map.set(v.forecast_id, []); map.get(v.forecast_id).push(v); });
    return map;
  }

  function subscribeRealtime(){
    sb.channel('willow-forecasts-admin')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'forecasts' }, (payload) => {
        const local = (function(){ try { return JSON.parse(localStorage.getItem('willow_forecasts')||'[]'); } catch { return []; } })();
        const map=new Map(local.map(f=>[f.id,f]));
        const row = payload.new || payload.old;
        if(payload.eventType==='DELETE'){ map.delete(row.id); }
        else {
          const cur=map.get(row.id);
          if(!cur || new Date(row.updated_at||0) >= new Date(cur.updated_at||0)) map.set(row.id, row);
        }
        localStorage.setItem('willow_forecasts', JSON.stringify([...map.values()]));
        try { if(typeof refreshForecastList==='function') refreshForecastList(); } catch {}
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'forecast_votes' }, async () => {
        try { const votesMap = await pullVotes(); refreshForecastList(votesMap); } catch {}
      })
      .subscribe();
  }

  await pullForecastsFromServer();
  const votesMap = await pullVotes(); try{ refreshForecastList(votesMap); }catch{}
  subscribeRealtime();
</script>

<!-- AI suggestions from tag stats -->
<script type="module">
  const sb2 = window.__supa;
  async function fetchUserTagStats(){
    const { data, error } = await sb2.from('user_tag_stats').select('most_tags, least_tags');
    if (error) { console.warn('[Willow] tag stats error', error); return []; }
    return data || [];
  }
  function aggregatePopularTags(rows){
    const counts = new Map();
    rows.forEach(r => (r.most_tags||[]).forEach(t => counts.set(t, (counts.get(t)||0)+3)));
    rows.forEach(r => (r.least_tags||[]).forEach(t => counts.set(t, (counts.get(t)||0)+1)));
    try {
      const notes = JSON.parse(localStorage.getItem('willow_notes')||'[]');
      notes.forEach(n => (n.tags||[]).forEach(t => counts.set(t, (counts.get(t)||0)+2)));
    } catch {}
    return [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([t])=>t);
  }
  function makeQuestionTemplates(tag){
    const yr = new Date().getFullYear();
    return [
      `Will ${tag} risks materially increase by ${yr}?`,
      `Will policy changes related to ${tag} be enacted by ${yr}?`,
      `Will markets price a ${tag} shock (â‰¥1Ïƒ daily move) before ${yr+1}-06-30?`
    ];
  }
  function renderSuggestions(tags){
    const box=document.getElementById('suggestionsBox'); const rows=[];
    tags.forEach(tag=>{
      const qs=makeQuestionTemplates(tag);
      qs.forEach(q=>rows.push(`<div class="prop-card"><div><strong>${q}</strong></div><div class="row" style="margin-top:6px;"><button class="btn primary" data-use-q="${encodeURIComponent(q)}" data-tag="${encodeURIComponent(tag)}">Use this</button></div></div>`));
    });
    box.innerHTML = rows.join('') || '<div class="muted">No tag signals yet.</div>';
    box.querySelectorAll('[data-use-q]').forEach(btn=>btn.addEventListener('click',()=>{
      const q=decodeURIComponent(btn.getAttribute('data-use-q')); const tag=decodeURIComponent(btn.getAttribute('data-tag'));
      document.getElementById('fcTitle').value=q;
      document.getElementById('fcCriteria').value=`Track via notes tagged â€œ${tag}â€. Define resolution consistent with the question.`;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }));
  }
  document.getElementById('genSuggest')?.addEventListener('click', async ()=>{
    const rows = await fetchUserTagStats(); const tags = aggregatePopularTags(rows); renderSuggestions(tags);
  });
</script>

<!-- Admin: view votes with email (RPC) -->
<script type="module">
  const sb = window.__supa;

  function wireVoteViews() {
    document.querySelectorAll('#fcList .card[data-fid]').forEach((card) => {
      if (card.__votesWired) return; card.__votesWired = true;

      const topRow = card.querySelector('.row'); // header row
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'View votes';
      btn.style.marginLeft = 'auto';

      const box = document.createElement('div');
      box.className = 'prop-card';
      box.style.display = 'none';
      box.innerHTML = '<div class="muted">Loadingâ€¦</div>';

      topRow.appendChild(btn);
      card.appendChild(box);

      let open = false, loaded = false;
      btn.addEventListener('click', async () => {
        open = !open;
        box.style.display = open ? 'block' : 'none';
        btn.textContent = open ? 'Hide votes' : 'View votes';
        if (!open || loaded) return;

        const fid = card.getAttribute('data-fid');
        try {
          const { data, error } = await sb.rpc('admin_votes_with_emails', { fid });
          if (error) throw error;

          if (!data || data.length === 0) {
            box.innerHTML = '<div class="muted">No votes yet or you are not an admin.</div>';
            loaded = true;
            return;
          }

          const rows = data
            .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))
            .map(v => `
              <tr>
                <td>${(v.email || '').replace(/</g,'&lt;') || v.user_id}</td>
                <td style="text-align:right;">${Math.round(v.prob * 100)}%</td>
                <td>${(v.rationale || '').replace(/</g,'&lt;')}</td>
                <td>${new Date(v.created_at).toLocaleString()}</td>
              </tr>
            `).join('');

          box.innerHTML = `
            <div style="overflow:auto">
              <table style="width:100%;border-collapse:collapse">
                <thead>
                  <tr>
                    <th style="text-align:left;border-bottom:1px solid var(--line);padding:4px 0">User (email)</th>
                    <th style="text-align:right;border-bottom:1px solid var(--line);padding:4px 0">Prob</th>
                    <th style="text-align:left;border-bottom:1px solid var(--line);padding:4px 0">Why</th>
                    <th style="text-align:left;border-bottom:1px solid var(--line);padding:4px 0">Time</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
          loaded = true;
        } catch (e) {
          console.error('[Willow] votes view error', e);
          box.innerHTML = '<div class="muted">Unable to load votes (are you admin?).</div>';
        }
      });
    });
  }

  // First wire, then re-wire on refreshes
  wireVoteViews();
  const _origRefresh = window.refreshForecastList;
  if (typeof _origRefresh === 'function') {
    window.refreshForecastList = function(...args) {
      _origRefresh.apply(this, args);
      wireVoteViews();
    };
  }
</script>
</body>
</html>
