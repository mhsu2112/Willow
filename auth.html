<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Willow — Sign in</title>
<style>
  :root { --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#4f46e5; --bg:#f8fafc; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  main{max-width:420px;margin:8vh auto;padding:20px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}
  button{font:inherit;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .muted{color:#64748b}
</style>
</head>
<body>
<main>
  <div class="card">
    <h1 style="margin:0 0 6px 0;">Sign in to Willow</h1>
    <p class="muted">Use Google or email/password.</p>
    <div class="row" style="margin-top:8px;">
      <button id="google" class="btn primary">Continue with Google</button>
    </div>
    <div style="margin-top:12px;">
      <label>Email<br/><input id="email" type="email" placeholder="you@example.com"></label><br/><br/>
      <label>Password<br/><input id="password" type="password" placeholder="••••••••"></label>
      <div class="row" style="margin-top:8px;">
        <button id="signin" class="btn">Sign in</button>
        <button id="signup" class="btn">Sign up</button>
      </div>
    </div>
    <p class="muted" id="msg" style="margin-top:10px;"></p>
  </div>
</main>

<script>
  window.WILLOW_CFG = {
    url: 'https://seolktqxdxstwqdiqzke.supabase.co',
    anon: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlb2xrdHF4ZHhzdHdxZGlxemtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjc0MjAsImV4cCI6MjA3MDk0MzQyMH0.Qt6wLLfR1QxbYGpq42t1uwpy5kDdqb_LN5-JA89Fj-U'
  };
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const cfg = window.WILLOW_CFG;

  const originHost = new URL(cfg.url).host;
  const withApiKeyQuery = async (input, init) => {
    const reqUrl = typeof input === 'string' ? input : input.url;
    try {
      const u = new URL(reqUrl);
      if (u.host === originHost && u.pathname.includes('/rest/v1/')) {
        if (!u.searchParams.has('apikey')) u.searchParams.set('apikey', cfg.anon);
      }
      return fetch(u.toString(), init);
    } catch {
      return fetch(input, init);
    }
  };

  const supa = createClient(cfg.url, cfg.anon, {
    auth: { persistSession: true, autoRefreshToken: true },
    global: { headers: { apikey: cfg.anon }, fetch: withApiKeyQuery }
  });

  const msg = document.getElementById('msg');
  function setMsg(t){ msg.textContent = t; }

  document.getElementById('google').onclick = async ()=>{
    try {
      const { error } = await supa.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: new URL('index.html', location.href).href
        }
      });
      if (error) setMsg('Google sign-in error: ' + error.message);
      else setMsg('Redirecting to Google…');
    } catch (e) { setMsg('Google sign-in failed'); console.error(e); }
  };

  document.getElementById('signin').onclick = async ()=>{
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) return setMsg('Enter email and password');
    const { error } = await supa.auth.signInWithPassword({ email, password });
    if (error) setMsg('Sign in error: ' + error.message);
    else location.href = 'index.html';
  };

  document.getElementById('signup').onclick = async ()=>{
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) return setMsg('Enter email and password');
    const { error } = await supa.auth.signUp({ email, password });
    if (error) setMsg('Sign up error: ' + error.message);
    else setMsg('Check your email to confirm, then sign in.');
  };
</script>
</body>
</html>
